<div class="page-header">
  <h3>All Product</h3>
  <div class="header-action">
    <button nz-button nzType="text" (click)="onRefresh()">
      <i class="las la-sync"></i>
    </button>
    <button nz-button nzType="text" (click)="exportPopUpShow()">Export</button>
    <button nz-button nzType="text" (click)="exportPopUpShow()">Import</button>
    <button nz-button nzType="primary" [routerLink]="['../../', 'add-product']">
      New Product
    </button>
  </div>
</div>

<nz-card nzSize="small">
  <nz-tabset>
    <nz-tab
      nz-tab
      *ngFor="let tab of tabs"
      (nzSelect)="onFilterSelectChange(tab.value)"
      [nzTitle]="tab.label"
    ></nz-tab>
  </nz-tabset>
  <div class="products-search-area">
    <div class="search" (click)="onClickSearchArea($event)">
      <button><i class="fa fa-search"></i></button>
      <form #searchForm="ngForm" style="width: 100%">
        <input
          #searchInput
          id="searchInput"
          class="tw"
          type="text"
          placeholder="Filter Products"
          (focus)="handleFocus($event)"
          name="searchTerm"
          autocomplete="off"
          ngModel
          required
        />
      </form>
    </div>
    <div class="products-search-area-btn">
      <ul>
        <li>
          <button [matMenuTriggerFor]="changeProductStatus">
            Bulk Action <i class="fa fa-caret-down"></i>
          </button>
        </li>
        <mat-menu #changeProductStatus="matMenu">
          <button mat-menu-item (click)="deleteBulkProducts()">Delete</button>
          <button mat-menu-item (click)="changeStatus(1)">Draft</button>
          <button mat-menu-item (click)="changeStatus(2)">Active</button>
        </mat-menu>
        <li>
          <button [matMenuTriggerFor]="productSort">
            Sort <i class="fa fa-caret-down"></i>
          </button>
        </li>
        <mat-menu #productSort="matMenu">
          <button
            mat-menu-item
            (click)="sortData({ name: 1 }, 1)"
            [class.dropdown-active]="activeSort === 1"
          >
            Product Title (A-Z)
          </button>
          <button
            mat-menu-item
            (click)="sortData({ createdAt: 1 }, 2)"
            [class.dropdown-active]="activeSort === 2"
          >
            Created (Oldest First)
          </button>
          <button
            mat-menu-item
            (click)="sortData({ quantity: -1 }, 3)"
            [class.dropdown-active]="activeSort === 3"
          >
            High Inventory
          </button>
          <!-- need to change -->
          <button
            mat-menu-item
            (click)="sortData({ categoryName: -1 }, 4)"
            [class.dropdown-active]="activeSort === 4"
          >
            Product Type (A-Z)
          </button>
          <button
            mat-menu-item
            (click)="sortData({ vendor: 1 }, 5)"
            [class.dropdown-active]="activeSort === 5"
          >
            Vendor (A-Z)
          </button>
        </mat-menu>
        <li><button>More</button></li>
      </ul>
    </div>
  </div>
  <nz-table #nestedTable [nzLoading]="isLoading" [nzData]="products">
    <thead>
      <tr>
        <th></th>
        <th
          [nzChecked]="checked"
          [nzIndeterminate]="indeterminate"
          (nzCheckedChange)="onAllSelectChange($event)"
        ></th>
        <th>Image</th>
        <th>Product</th>
        <th></th>
        <th>Sku</th>
        <th>Price</th>
        <th>Qty</th>
        <!-- <th>Variants</th> -->
        <th>Status</th>
        <th>Type</th>
        <th>Earn Points</th>
        <th>Redeem Points</th>
        <th>Vendor</th>
      </tr>
    </thead>
    <tbody>
      <ng-template ngFor let-data [ngForOf]="nestedTable.data">
        <tr>
          <td
            [class]="data.hasVariant ? '' : 'hidePlus'"
            [nzExpand]="expandSet.has(data._id) && data.hasVariant"
            (nzExpandChange)="onExpandChange(data._id, $event)"
          ></td>
          <td
            [nzChecked]="setOfCheckedId.has(data._id)"
            (nzCheckedChange)="onCheckChange($event, i, data._id)"
          ></td>
          <td>
            <img
              style="width: 40px; cursor: pointer"
              nz-image
              [nzSrc]="
                setThumbnailImage(data)
                  ? setThumbnailImage(data)
                  : '/assets/images/placeholder/test.png'
              "
              alt=""
            />
          </td>
          <td>
            <a
              class="text"
              [routerLink]="['../../', 'add-product', data._id]"
              >{{ data.name }}</a
            >
          </td>
          <td>
            <a
              target="_blank"
              [routerLink]="['../../../', 'product-details', data.slug]"
            >
              <i class="eyeButton" class="fa fa-eye"></i>
            </a>
          </td>
          <td>
            <span
              ><b>{{ data?.sku }}</b></span
            >
          </td>
          <td>{{ data?.sellingPrice }}</td>
          <td>{{ data?.quantity }}</td>
          <!-- <td>{{data.variantFormArray.length}}</td> -->
          <td>
            <nz-select
              [(ngModel)]="data.status"
              nzPlaceHolder="Choose"
              [nzOptions]="productStatus"
              (ngModelChange)="onStatusChange(data.status, data, data._id)"
            ></nz-select>
          </td>
          <td>
            {{ data?.productType?.name ? data.productType.name : "None" }}
          </td>
          <td>
            <span *ngIf="!data.canEarnPoints">0</span>
            <span *ngIf="data.canEarnPoints"
              >{{ data.earnPoints }}
              {{ data.earnPointsType | amountType }}</span
            >
          </td>
          <td>
            <span *ngIf="!data.canRedeemPoints">0</span>
            <span *ngIf="data.canRedeemPoints"
              >{{ data.redeemPoints }}
              {{ data.redeemPointsType | amountType }}</span
            >
          </td>
          <td>
            <span>{{ data?.vendor?.name }}</span>
          </td>
        </tr>
        <tr [nzExpand]="expandSet.has(data?._id) && data?.hasVariant">
          <nz-table
            [nzData]="nestedTable?.data"
            nzSize="middle"
            [nzShowPagination]="false"
          >
            <thead>
              <tr>
                <th>SKU</th>
                <th *ngFor="let variantType of data.variants; let i = index">
                  {{ variantType }}
                </th>
                <th>Qty</th>
                <th>Re-order</th>
                <th>Status</th>
                <th>Pre Order</th>
                <th>Price</th>
                <th>Vendor</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let variant of data.variantFormArray; let i = index">
                <td>{{ variant.variantSku }}</td>
                <td *ngFor="let type of data.variants; let x = index">
                  {{ this.getVariantName(i, type, data) }}
                </td>
                <td>{{ variant.variantQuantity }}</td>
                <td>{{ variant.variantReOrder }}</td>
                <td>
                  <span [class]="getVariantStatusColor(variant)">{{
                    getVariantStatus(variant)
                  }}</span>
                </td>
                <td>
                  <label
                    nz-checkbox
                    [(ngModel)]="variant.variantContinueSelling"
                    >{{
                      variant?.variantContinueSelling ? "On " : "Off "
                    }}</label
                  >
                </td>
                <td>
                  <span>{{ variant.variantPrice }}</span>
                </td>
                <td>
                  <span>{{ variant.variantVendorName.name }}</span>
                </td>
              </tr>
            </tbody>
          </nz-table>
        </tr>
      </ng-template>
    </tbody>
  </nz-table>
</nz-card>

<div class="export-popup-area">
  <app-export-popup
    (valueChange)="exportToExcel($event)"
    #export
  ></app-export-popup>
</div>
